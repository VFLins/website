<!doctype html>
<meta charset="utf-8">
<link rel="stylesheet" href="../../static/pygments.css">
<link rel="stylesheet" href="../../static/style.css">
<script src="../../static/toggle-theme.js"></script>
<title>Melhorias no backend do Cashd com Toga — Vitor F. Lins</title>
<body>
    <header>
        <h1><b>Vitor F. Lins</b></h1>
        <nav>
            <ul class="nav navbar-nav">
                <li>
                    <a href="../../">Início</a>
                </li>
                
                    <li class="active"><a href="../">Blog</a></li>
                
                    <li><a href="../../projetos/">Projetos</a></li>
                
                    <li><a href="../../sobre/">Sobre mim</a></li>
                
                <li style="color:var(--page-text);float:right"><input type="checkbox" id="theme-toggle"><label for="theme-toggle">Tema claro</label></li>
            </ul>
        </nav>
    </header>
    <div class="page">
        
  
  <div class="blog-post">
  
    <h1>Melhorias no backend do Cashd com Toga</h1>
  
  <p class="meta">2025-07-08
     |
        
            <code><a href="../../tag/Cashd/">Cashd</a></code>
        
            <code><a href="../../tag/Novo_recurso/">Novo recurso</a></code>
        
    
  </p>
  <blockquote class="callout-success">

    <p><b>✅ O <i>backend</i> está pronto e testado</b></p>

    <p>Algumas mudanças estruturais foram feitas no código, a lógica de interação com o banco
    de dados agora adere ao paradigma de "Programação Orientada a Objetos" em vez do
    paradigma "Funcional". Além disso, também podemos processar os dados direto na engine do
    banco de dados, o que nos dá um ganho muito relevante de desempenho.</p>

    <p>Isto conclui a primeira tarefa de: <a href="../2025-06-16/">"Melhorar a
    qualidade da interação com o banco de dados, evitando carregar muitos dados 
    desnecessariamente"</a>.</p>

</blockquote><h2>A validação de dados agora é feita pelo <code>sqlalchemy</code></h2>
<p>O projeto original do <code>Cashd</code>, usava um <code>cashd.db.FormObj</code> para fazer a validação e
formatação dos inputs com código totalmente próprio, mas agora usamos o
<a href="https://docs.sqlalchemy.org/en/20/core/custom_types.html#sqlalchemy.types.TypeDecorator"><code>TypeDecorator</code></a>
para sinalizar as regras de formatação dos dados ao <code>sqlalchemy</code>.</p>
<h2>Dados formatados e interativos com <code>cashd.data._DataSource</code></h2>
<p>Uma nova classe chamada <code>_DataSource</code> traz as funcionalidades para:</p>
<ol>
    <li>
    Fazer o pré-processamento direto no banco de dados;</li>
    <li>
    Lidar com paginação, onde o usuário vê apenas um recorte dos dados, e pode solicitar 
    o "próximo recorte" interagindo com a interface gráfica;</li>
    <li>
    Lidar com pesquisa, procurando por palavras-chave em múltiplas colunas do conjunto de
    dados retornados pelo <code>_DataSource</code>;</li>
    <li>
    Em caso de série temporal, mudar a frequência dos dados entre mensal, semanal e diário.</li>
</ol><h2>CRUD feito pelas tabelas declaradas</h2>
<p>As operações de CRUD, que antes eram realizadas por funções especializadas, agora são
funções genéricas que usam as classes herdeiras da
<a href="https://docs.sqlalchemy.org/en/20/orm/declarative_tables.html">base declarativa</a>,
agora podemos preencher um <code>cashd.data.tbl_clientes</code> com dados e gerenciá-lo no banco de
dados com os novos métodos:</p>
<div class="hll"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">cashd</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span>

<span class="n">customer</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_default_customer</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;`tbl_clientes` preenchido com os valores padrão.&quot;&quot;&quot;</span>

<span class="n">customer</span><span class="o">.</span><span class="n">PrimeiroNome</span> <span class="o">=</span> <span class="s2">&quot;José&quot;</span>
<span class="n">customer</span><span class="o">.</span><span class="n">Sobrenome</span> <span class="o">=</span> <span class="s2">&quot;Da Silva&quot;</span>
<span class="sd">&quot;&quot;&quot;Preenche os campos obrigatórios que não são preenchidos por padrão.&quot;&quot;&quot;</span>

<span class="n">customer</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Cria uma nova linha na tabela &#39;clientes&#39; do banco de dados contendo</span>
<span class="sd">os dados de `customer`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">customer</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">row_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Preenche `customer` com os dados da primeira linha da tabela &#39;clientes&#39;.&quot;&quot;&quot;</span>

<span class="n">customer</span><span class="o">.</span><span class="n">Bairro</span> <span class="o">=</span> <span class="s2">&quot;Novo Bairro&quot;</span>
<span class="n">customer</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Atualiza a linha correspondente no banco de dados.&quot;&quot;&quot;</span>

<span class="n">customer</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;Remove a linha correspondente do banco de dados.&quot;&quot;&quot;</span>
</pre></div>
<h2>Novos testes</h2>
<p>Foram adicionados testes unitários adicionais para o novo código que interage com o banco de dados, com cobertura do código presente em <code>data.py</code> de 92%.</p>

  </div>


    </div>
    <footer>
        &copy; Copyright 2025 by Vitor F. Lins.
    </footer>
</body>
